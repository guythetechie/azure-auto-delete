name: Deploy to Azure

on: push

env:
  AZURE_FUNCTIONS_ARTIFACT_NAME: azure-functions

jobs:
  deploy_infrastructure:
    name: Deploy Azure infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Deploy infrastructure
        run: echo "Deploying infrastructure..."

  test:
    name: Test Azure function
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.x
      - name: Test Azure function
        run: |
          set -Eeuo pipefail
          dotnet test "${GITHUB_WORKSPACE}/code/azurefunctions.tests/azurefunctions.tests.csproj"

  compile:
    name: Compile Azure function
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.x
      - name: Set output directory
        run: |
          echo "FUNCTION_OUTPUT_DIRECTORY=${RUNNER_TEMP}/functionoutput" >> $GITHUB_ENV
      - name: Build Azure function
        run: |
          set -Eeuo pipefail
          dotnet build "${GITHUB_WORKSPACE}/code/azurefunctions/azurefunctions.csproj" --configuration Release --output "${{ env.FUNCTION_OUTPUT_DIRECTORY }}"
      - name: Save output
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.AZURE_FUNCTIONS_ARTIFACT_NAME }}
          path: ${{ env.FUNCTION_OUTPUT_DIRECTORY }}
          if-no-files-found: error
          retention-days: 1

  publish:
    name: Publish Azure function
    needs:
      - deploy_infrastructure
      - test
      - compile
    runs-on: ubuntu-latest
    steps:
      - name: Set output directory
        run: |
          echo "FUNCTION_OUTPUT_DIRECTORY=${RUNNER_TEMP}/functionoutput" >> $GITHUB_ENV
      - name: Download function artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.AZURE_FUNCTIONS_ARTIFACT_NAME }}
          path: ${{ env.FUNCTION_OUTPUT_DIRECTORY }}